<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Three-Body Orbit Tester</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: #1a1a2e;
            color: #eee;
            min-height: 100vh;
        }
        .container {
            display: flex;
            height: 100vh;
        }
        .sidebar {
            width: 280px;
            background: #16213e;
            padding: 20px;
            overflow-y: auto;
            border-right: 1px solid #0f3460;
        }
        .sidebar h1 {
            font-size: 1.2em;
            margin-bottom: 20px;
            color: #e94560;
        }
        .orbit-list {
            list-style: none;
        }
        .orbit-list li {
            margin-bottom: 8px;
        }
        .orbit-btn {
            width: 100%;
            padding: 10px 15px;
            background: #0f3460;
            border: none;
            border-radius: 6px;
            color: #eee;
            cursor: pointer;
            text-align: left;
            font-size: 0.9em;
            transition: all 0.2s;
        }
        .orbit-btn:hover {
            background: #1a4a7a;
        }
        .orbit-btn.active {
            background: #e94560;
        }
        .main {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        .canvas-container {
            flex: 1;
            position: relative;
            background: #000;
        }
        #canvas {
            width: 100%;
            height: 100%;
        }
        .info-bar {
            background: #16213e;
            padding: 15px 20px;
            display: flex;
            gap: 30px;
            flex-wrap: wrap;
            border-top: 1px solid #0f3460;
        }
        .info-item {
            display: flex;
            flex-direction: column;
        }
        .info-label {
            font-size: 0.75em;
            color: #888;
            text-transform: uppercase;
        }
        .info-value {
            font-size: 1.1em;
            font-family: "SF Mono", Monaco, monospace;
        }
        .controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .control-btn {
            padding: 8px 16px;
            background: #0f3460;
            border: none;
            border-radius: 4px;
            color: #eee;
            cursor: pointer;
            font-size: 0.85em;
        }
        .control-btn:hover {
            background: #1a4a7a;
        }
        .energy-ok { color: #4ade80; }
        .energy-warn { color: #fbbf24; }
        .energy-bad { color: #f87171; }
    </style>
</head>
<body>
    <div class="container">
        <aside class="sidebar">
            <h1>Three-Body Orbits</h1>
            <ul class="orbit-list" id="orbitList"></ul>
        </aside>
        <main class="main">
            <div class="canvas-container">
                <canvas id="canvas"></canvas>
            </div>
            <div class="info-bar">
                <div class="info-item">
                    <span class="info-label">Orbit</span>
                    <span class="info-value" id="orbitName">-</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Time</span>
                    <span class="info-value" id="simTime">0.000</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Initial Energy</span>
                    <span class="info-value" id="initialEnergy">-</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Current Energy</span>
                    <span class="info-value" id="currentEnergy">-</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Energy Drift</span>
                    <span class="info-value" id="energyDrift">-</span>
                </div>
                <div class="controls">
                    <button class="control-btn" id="resetBtn">Reset</button>
                    <button class="control-btn" id="pauseBtn">Pause</button>
                    <button class="control-btn" id="clearTrailsBtn">Clear Trails</button>
                </div>
            </div>
        </main>
    </div>

    <!-- Cache-busting: append ?v=timestamp when debugging cache issues -->
    <script src="../js/three_body_sim.js?v=2"></script>
    <script>
        (function() {
            "use strict";

            // Canvas setup
            var canvas = document.getElementById("canvas");
            var ctx = canvas.getContext("2d");

            // State
            var sim = null;
            var trails = [[], []];
            var initialEnergy = 0;
            var paused = false;
            var animId = null;

            // Config
            var CONFIG = {
                trailLength: 3000,
                timePerFrame: 0.02,
                coordRange: 5,
                bodyColors: ["#ff6b6b", "#4ecdc4", "#ffe66d"],
                trailAlpha: 0.6
            };

            // Fit canvas to container
            function fitCanvas() {
                var container = canvas.parentElement;
                canvas.width = container.clientWidth;
                canvas.height = container.clientHeight;
            }
            window.addEventListener("resize", fitCanvas);
            fitCanvas();

            // Coordinate mapping
            function toCanvas(sx, sy) {
                var scale = Math.min(canvas.width, canvas.height) / CONFIG.coordRange;
                return {
                    x: canvas.width / 2 + sx * scale,
                    y: canvas.height / 2 - sy * scale
                };
            }

            // Populate orbit list
            var orbitList = document.getElementById("orbitList");
            var buttons = {};
            ThreeBodySim.CONFIG_KEYS.forEach(function(key) {
                var config = ThreeBodySim.CONFIGS[key];
                var li = document.createElement("li");
                var btn = document.createElement("button");
                btn.className = "orbit-btn";
                btn.textContent = config.name;
                btn.addEventListener("click", function() {
                    selectOrbit(key);
                });
                li.appendChild(btn);
                orbitList.appendChild(li);
                buttons[key] = btn;
            });

            // Select orbit
            function selectOrbit(key) {
                // Update button states
                Object.keys(buttons).forEach(function(k) {
                    buttons[k].classList.remove("active");
                });
                buttons[key].classList.add("active");

                // Create simulation
                sim = new ThreeBodySim.Simulation(key);
                trails = [[], [], []];
                initialEnergy = sim.totalEnergy();

                // Update display
                document.getElementById("orbitName").textContent = sim.configName;
                document.getElementById("initialEnergy").textContent = initialEnergy.toFixed(6);

                // Start animation if not running
                if (!animId) {
                    animate();
                }
            }

            // Animation loop
            function animate() {
                if (!paused && sim) {
                    sim.advance(CONFIG.timePerFrame);

                    // Record trails
                    var positions = sim.getPositions();
                    for (var i = 0; i < 3; i++) {
                        trails[i].push({ x: positions[i].x, y: positions[i].y });
                        if (trails[i].length > CONFIG.trailLength) {
                            trails[i].shift();
                        }
                    }
                }

                draw();
                animId = requestAnimationFrame(animate);
            }

            // Draw frame
            function draw() {
                var w = canvas.width;
                var h = canvas.height;

                // Clear
                ctx.fillStyle = "#000";
                ctx.fillRect(0, 0, w, h);

                if (!sim) return;

                // Draw trails
                for (var b = 0; b < 3; b++) {
                    var trail = trails[b];
                    var color = CONFIG.bodyColors[b];

                    ctx.strokeStyle = color;
                    ctx.lineWidth = 1.5;
                    ctx.globalAlpha = CONFIG.trailAlpha;

                    if (trail.length > 1) {
                        ctx.beginPath();
                        var p0 = toCanvas(trail[0].x, trail[0].y);
                        ctx.moveTo(p0.x, p0.y);
                        for (var i = 1; i < trail.length; i++) {
                            var p = toCanvas(trail[i].x, trail[i].y);
                            ctx.lineTo(p.x, p.y);
                        }
                        ctx.stroke();
                    }
                }
                ctx.globalAlpha = 1;

                // Draw bodies
                var positions = sim.getPositions();
                for (var b = 0; b < 3; b++) {
                    var p = toCanvas(positions[b].x, positions[b].y);
                    var color = CONFIG.bodyColors[b];

                    // Glow
                    var gradient = ctx.createRadialGradient(p.x, p.y, 0, p.x, p.y, 20);
                    gradient.addColorStop(0, color);
                    gradient.addColorStop(1, "rgba(0,0,0,0)");
                    ctx.fillStyle = gradient;
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, 20, 0, Math.PI * 2);
                    ctx.fill();

                    // Core
                    ctx.fillStyle = "#fff";
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, 4, 0, Math.PI * 2);
                    ctx.fill();
                }

                // Update info
                document.getElementById("simTime").textContent = sim.time.toFixed(3);
                var currentE = sim.totalEnergy();
                document.getElementById("currentEnergy").textContent = currentE.toFixed(6);

                var drift = Math.abs((currentE - initialEnergy) / initialEnergy) * 100;
                var driftEl = document.getElementById("energyDrift");
                driftEl.textContent = drift.toFixed(6) + "%";

                // Color code energy drift
                driftEl.className = "info-value ";
                if (drift < 0.01) {
                    driftEl.classList.add("energy-ok");
                } else if (drift < 0.1) {
                    driftEl.classList.add("energy-warn");
                } else {
                    driftEl.classList.add("energy-bad");
                }
            }

            // Controls
            document.getElementById("resetBtn").addEventListener("click", function() {
                if (sim) {
                    sim.reset();
                    trails = [[], [], []];
                    initialEnergy = sim.totalEnergy();
                }
            });

            document.getElementById("pauseBtn").addEventListener("click", function() {
                paused = !paused;
                this.textContent = paused ? "Resume" : "Pause";
            });

            document.getElementById("clearTrailsBtn").addEventListener("click", function() {
                trails = [[], [], []];
            });

            // Select first orbit by default
            if (ThreeBodySim.CONFIG_KEYS.length > 0) {
                selectOrbit(ThreeBodySim.CONFIG_KEYS[0]);
            }
        })();
    </script>
</body>
</html>
